<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Hacking on clojure.core & runtime</title>

		<link rel="stylesheet" href="css/reset.css">
		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/black.css">

		<!-- Theme used for syntax highlighting of code -->
		<!-- <link rel="stylesheet" href="lib/css/monokai.css"> -->
		<link rel="stylesheet" href="css/theme/solarized.css" id="theme">

		<style>
			@font-face {
				font-family: 'Gill Sans';
				font-style: normal;
				font-weight: 400;
				src: url('/fonts/GillSans.ttf') format("truetype");
			}

			.reveal section img.plain {
			  width: 50%;
			}
	   
			.reveal section img.big {
			  width: 90%;
			}

			.reveal section h3 {
				text-transform: none;
			}

			.reveal,
			.reveal h1,
			.reveal h2,
			.reveal h3,
			.reveal h4,
			.reveal h5,
			.reveal h6 {
				font-family: 'Gill Sans', sans-serif !important;
			}

			.reveal section pre code {
				font-size: 4em;
				line-height: 1.5em;
				max-height: 600px;
			}

			.reveal section > ul > li {
				font-size: 2.2em;
			}

			/* .reveal section.margined ul {
				margin-bottom: 1.2em;
			} */

			.reveal section ul {
				margin-bottom: 0.2em;
			}

			.reveal section .borderless {
				border: none;
				box-shadow: none;
			}

			img.clj,
			img.razum2um,
			img.mad,
			img.godeeper,
			img.hardcode,
			img.map {
				height: 700px;
			}

			img.why {
				height: 1200px;
			}

			img.miniclj {
				height: 300px;
			}

			img.minigolang {
				height: 300px;
			}

			.logos {
				position: absolute;
				display: flex;
				width: 1400px;
				top: 30%;
				justify-content: space-between;
				left: 50%;
    			transform: translate(-50%, 0);
			}

			.logos .minigolang {
				margin-top: 250px;
			}

			.disclaimer {
				font-size: 0.5em;
			}

			.flex {
				display: flex;
				justify-content: center;
				align-items: center;
			}

			.vflex {
				flex-direction: column;
			}

			.push-down {
				margin-top: 5em;
			}

			.reveal li {
				list-style-type: square;
			}

			.reveal .lower {
				text-transform: lowercase;
			}

			.reveal .capital {
				text-transform: capitalize;
			}

			.reveal .twophase,
			.reveal .gtrend {
				max-height: 500px;
			}
		</style>

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
					<img class='borderless clj' src='lib/images/clj.png' />
					<h1>Hacking on clojure.core & runtime</h1>
				</section>

				<section>
					<img src="lib/images/razum2um.jpg" alt="razum2um" class="borderless razum2um" />
					<h2>Vlad Bokov</h2>
					<h3><a href="http://lunatic.cat">vlad@lunatic.cat</a></h3>
					<aside class="notes">
						- we're doing outsource and continiously making things simpler(?)
					</aside>
				</section>

				<!-- <section>
					<img src="lib/images/mad.jpg" alt="mad" class="borderless mad" />
					<h2>Mad Bokov</h2>
					<aside class="notes">
						- like to give mad talks
					</aside>
				</section> -->

				<section data-markdown>
					<textarea data-template>
						# whoami
						
						- 5 yrs clojure developmemt
						- [author](https://github.com/razum2um?utf8=%E2%9C%93&tab=repositories&q=&type=source&language=clojure) of a [few](https://github.com/clojure-ru?utf8=%E2%9C%93&q=&type=source&language=clojure) [libs](https://github.com/lunatic-cat?utf8=%E2%9C%93&q=&type=source&language=clojure)
						- [awesome-clojure](https://github.com/razum2um/awesome-clojure) list curator
						- [@razum2um](https://twitter.com/razum2um) - tweet mostly about clojure / functional code
						
					</textarea>
					<aside class="notes">
						sometimes during my talk there will be some advertisements (which we all love) which mention some awesome libraries which you may not know,
						but if you don't please, check them out. this also resembles me on my very old idea how to make people return to the talk after the confs, 
						so the slides will be published, links will be available
						and you won't be alble to adblock this (hahaha), sad story: I wasn't not paid for them
	
						also you could check my list of clojurian who you also may be interested to follow
					</aside>
				</section>

				<section>
					<h1>Origin</h1>
					<img src="lib/images/map.png" alt="map" class="borderless map" />
					<div class="fragment logos">
						<img class='borderless miniclj' src='lib/images/clj.png' />
						<img class='borderless minigolang' src='lib/images/golang-russian.png' />
					</div>
					<aside class="notes">
						- barnaul from moscow as far as go from clojure
					</aside>
				</section>

				<section>
					<h1><a href="http://twitter.com/hardcodefm">@hardcodefm</a> host</h1>
					<img src="lib/images/hardcode.svg" alt="hardcodefm" class="borderless hardcode" />
					<h2 class="fragment">Psst, learn you some russian <br> for the great good</h2>
					<aside class="notes">
						I'm glad the content of this talk will be available for all the clojure developers 

						russian is worth learning, as while speaking about programming languages I tend to suggest people learning clojure,
						I suggest lispers to learn russian, guest why? because russian talk in lisp (TODO: slide picture from chat)
						but lets get serious, lets talk about brackets
					</aside>
				</section>

				<section>
					<img class='borderless why' src='lib/images/why-russian.png' />
				</section>

				<section>
					<h1>Let's get serios (a poll)</h1>
					<ul>
						<li class="fragment">encountered a clojure bug</li>
						<li class="fragment">debugged clojure (JDWP etc)</li>
						<li class="fragment">changed something inside clojure internals</li>
						<li class="fragment">contributed back</li>
					</ul>
					<aside class="notes">
						I started patching after being tiered of 
						some error message even back then at 1.6 
						they were even worse
						curiosity came afterwards
					</aside>
				</section>

				<section data-markdown>
					<textarea data-template>
						# Disclaimer

						- I will be speaking to different topics & my experience
						- Please, don't fork clojure for your production
						- Don't expect me to present my shiny fork or give advice
						- Be open to possible insigths
						- Starting point to dig into sources
						- Reopen the slides later again, check out the links
					</textarea>
					<aside class="notes">
						stay open minded
					</aside>
				</section>

				<section data-markdown>
					<textarea data-template>
						# Why talk about clojure?

						- close to ruby as per "change-anything" at runtime 
							- but JVM final + immutable
						- written in a clear high-level language
						- *relatively* performant
							- [clojure-goes-fast](http://clojure-goes-fast.com/)
						- source is quite educationable and *ideomatic*
						- builds relatively fast
					</textarea>
					<aside class="notes">
						- I'm keen to say that clj is the most flexible language (somewhere near ruby) I ever saw
						- doesn't require to think about memry management and c-extensions byte-level stuff
						- as the parser is basically a depth-first tree walk - a good (just as any lisp)
						- ruby parser is literally crazy, but clojure has first class persisstent ds impl
						- extensively uses RT and structures in source
					</aside>
				</section>

				<section data-markdown>
					<textarea data-template>
						# So, lets talk about...
					</textarea>
				</section>

				<!-- ///////// -->
		
				<section>
					<h1>Parens</h1>
					<h2 class="fragment">))))</h2>
				</section>	

				<section data-markdown>
					<textarea data-template>
						# What if you want

						```
						defn foo [x]
							map inc (range x)
						def my-list
							foo 10
						```
					</textarea>
				</section>

				<section data-markdown>
					<textarea data-template>
						# Ways to go

						- Macros
						- Tagged literals
						- clojure.lang.LispReader
					</textarea>
				</section>

				<section data-markdown>
					<textarea data-template>
						# Macros

						- can read arbitrary number/nested of Symbols
						- dont compose^W only compose with each other
						- you know'em, bro
					</textarea>
				</section>

				<section data-markdown>
					<textarea data-template>
						# Tagged literals

						- happens after parsing
						- can read only proper value (wrapped/scalar) 
						- contradicts clojure mantra
							- by [@puredanger](http://insideclojure.org/2018/06/21/tagged-literal/)
						- [example gist](https://gist.github.com/razum2um/bdde7d13f47c31e42046f7b0b6aa818d)
						
						```
						(jdef greeting "world")
						(println (str "hello " greeting))
						#jruby[puts "hello #{greeting}"]
						```
					</textarea>
					<aside class="notes">
						the goal of making all code readable by all users of Clojure, without requiring optional code.
						they are like contructors for non specific datatypes
						less than 20 lines
					</aside>
				</section>

				<section data-markdown>
					<textarea data-template>
						# [jwymanm/chiara](https://github.com/jwymanm/chiara)

						- done by macros
						- nobody cares for about 5 years
					</textarea>
					<aside class="notes">
						the goal of making all code readable by all users of Clojure, without requiring optional code.
					</aside>
				</section>

				<section data-markdown>
					<textarea data-template>
						# Let's talk about clojure.lang.LispReader
						
						### Short intro into clojure source
					</textarea>
				</section>

				<section data-markdown>
					<textarea data-template>
						# What if you tired to hold shift:
						
						```
						[take 10 [map inc [range 10]]]
						```
					</textarea>
				</section>

				<section data-markdown>
					<textarea data-template>
						# clojure.lang.LispReader
						
						- seems easy to change
						- indeed 4 lines-diff in reader
						- requires current clojure std to be rewritten
					</textarea>
					<aside class="notes">
						syntax? macros!
					</aside>
				</section>
					
				<!-- <section data-markdown>
					<textarea data-template>
						# Deal with it

						- src/jvm/clojure/lang/Compiler.java
						- src/jvm/clojure/lang/LispReader.java
						- src/jvm/clojure/lang/RT.java
					</textarea>
					<aside class="notes">
						unless you're interested in persisted datastructures
					</aside>
				</section>

				<section data-markdown>
					<textarea data-template>
						# Deal with it

						- src/jvm/clojure/lang/Compiler.java - 9125 lines
						- src/jvm/clojure/lang/LispReader.java - 1699 lines
						- src/jvm/clojure/lang/RT.java - 2438

						- intended in a very *special* way
						- *almost* exclusively written by Rich
						- *almost* untouched after 2011
					</textarea>	
					<aside class="notes">
						holy rich!
					</aside>
				</section>

				<section data-markdown>
					<textarea data-template>
						## Compiler

						- recursive analyzeSeq => Expr
						- switch on Parser classes
						- interface IParser { Expr parse(C context, Object form) }
					</textarea>
				</section> -->
	
				<!-- //////////////////  -->

				<section>
					<h1>Go deeper</h1>
					<img src="lib/images/go-deeper.jpg" alt="godeeper" class="borderless godeeper" />
				</section>

				<section data-markdown>
					<textarea data-template>
						# So, lets talk about...
					</textarea>
				</section>
			
				<section data-markdown>
					<textarea data-template>
						# Bugs

						- [261 bugs open atm](https://clojure.atlassian.net/browse/CLJ-2522?jql=project%20%3D%20CLJ%20AND%20issuetype%20%3D%20Bug%20AND%20status%20%3D%20Open%20AND%20resolution%20%3D%20Unresolved%20ORDER%20BY%20priority%20DESC)
						- there are farewell letters *due this*: [My Increasing Frustration With Clojure, 2016](http://ashtonkemerling.com/posts/my-increasing-frustration-with-clojure/)
						- he mentioned 5 very long-running issues, 4 of them are still there
					</textarea>
				</section>

				<section data-markdown>
					<textarea data-template>
						# Poll

						```
						(def a -10000000000000)
						(Math/abs a) ;; => ?
						```
					</textarea>
					<aside class="notes">
						Follow me, don't miss the latest hottest bugs out there
					</aside>
				</section>

				<section data-markdown>
					<textarea data-template>
						# Answer

						- 1316134912
						- [CLJ-1921](https://clojure.atlassian.net/browse/CLJ-1921)
						- why?
					</textarea>
				</section>

				<section data-markdown>
					<textarea data-template>
						# Dynamic types + interop != magic

						```
						(def ^Long a -10000000000000)
						(Math/abs a)
						Syntax error (IllegalArgumentException) 
						More than one matching method found: abs
						```
					</textarea>
				</section>

				<section data-markdown>
					<textarea data-template>
						# Dynamic types + interop != magic

						- static double abs(double a)
						- static float abs(float a)
						- static int abs(int a)
						- static long abs(long a)
					</textarea>
				</section>
			
				<section data-markdown>
					<textarea data-template>
						# Dynamic types + interop != magic

						- a is an Object
						- Reflector.invokeMatchingMethod
						- int version is found first
					</textarea>
				</section>


				<section data-markdown>
					<textarea data-template>
						# Lets try to workaround it

						### note: `^` is just a meta :tag
					</textarea>
				</section>

				<section data-markdown>
					<textarea data-template>
						# Lets auto apply workaround

						```
						(defmacro defdef [name & body]
						`(let [x# ~@body
							t# (type x#)
							v# (def ~name x#)]
						(alter-meta! v# assoc :tag t#)
						v#))
						```
					</textarea>
				</section>

				<section data-markdown>
					<textarea data-template>
						# How about redefine `def`, poll:

						### what happens here

						```
						(def def def)
						```
					</textarea>
				</section>

				<section data-markdown>
					<textarea data-template>
						# How about redefine `def`?

						- but `def` is not a clojure.lang.Var (no `alter-var-root`)
						- it's `(get clojure.lang.Compiler/specials "def")`
						- `clojure.lang.Compiler/specials` if `final` `PersistentHashMap`
					</textarea>
				</section>

				<section data-markdown>
					<textarea data-template>
						# @Compiler/specials

						### 4-line changes, [razum2um/clojure:cljdef](https://github.com/razum2um/clojure/compare/master...razum2um:cljdef)

						```
						(swap! clojure.lang.Compiler/specials
						  clojure.set/rename-keys {'def 'cljdef})
						(cljdef a 1) ;; => #'user/a
						(def x 2)    ;; => Syntax error
						```
					</textarea>
				</section>
	
				<section data-markdown>
					<textarea data-template>
						# Now what? ;; TODO
						
						- impl. a IParser, put into `Compiler/specials`
						- hook & track *all* the `def`initions across deps
						- theoretically we could store them elsewhere
						- and index/do best LSP
					</textarea>
					<aside class="notes">
						Did you know intelij has an own language parser inside all of theirs ides?
						i.e. it rejects anything what runtime suggests, it's a pity
						it's a lack of a strong self-aware runtime
					</aside>
				</section>

				<!-- ///// -->

				<section>
					<h1>Go deeper</h1>
					<img src="lib/images/go-deeper.jpg" alt="godeeper" class="borderless godeeper" />
				</section>

				<section data-markdown>
					<textarea data-template>
						# So, lets talk about...
					</textarea>
				</section>

				<section data-markdown>
					<textarea data-template>
						# So, lets talk about...
					</textarea>
				</section>

				<section data-markdown>
					<textarea data-template>
						# What if you want

						### (but java.util.regex.Pattern != IFn)

						```
						(->> [{:subj "hello" :to "clojuru"}
							  {:subj "hello" :to "world"}]
							 (filter (comp #"hello" :subj))
							 (remove (comp #"world" :to)))
						```
					</textarea>
				</section>

				<section data-markdown>
					<textarea data-template>
						# clojure.lang.IFn

						- Vector and Map implement this ❤️
						- functions are composable
						- yes, calling semantics is questionable
						- but y not?
					</textarea>
				</section>

				<section data-markdown>
					<textarea data-template>
						# clojure.lang.PatternFn

						### see [razum2um/clojure:pattern-ifn](https://github.com/razum2um/clojure/compare/master...razum2um:pattern-ifn)

						- got rid of many typehints :(
						- LispReader: RegexReader#invoke
						- RT: print
						- core_print.clj: print-dup & print-method
					</textarea>
				</section>

				<section class='margined' data-markdown>
					<textarea data-template>
						# Caveats

						- breaks `(def ^Pattern #"")`
							- [clojure/tools.reader](https://github.com/clojure/tools.reader/blob/23bfba4b3d4c35692beced1f2f64f818bdb64d75/src/main/clojure/clojure/tools/reader/impl/commons.clj#L46)
						- breaks `(instance? Pattern x)`
							- [AvisoNovate/pretty](https://github.com/AvisoNovate/pretty)
						- changes behaviour *tested* since 2009
						
						```
						FAIL in (test-type-preds)
								(predicates.clj:132)
						(not ("ifn?" #"a*b"))
						```
					</textarea>
					<aside class="notes">
						- one may argue that a logic shouldn't depend on classes and types, 
						but people are doing this way
					</aside>
				</section>
			
				<!-- //////////////////  -->
				
				<section data-markdown>
					<textarea data-template>
						# WHY#1

						- I want to keep thinking in clojure 
						- use clojure fns, semantic, dynamism / jvm batteries
						- stay in REPL
						- not access REPL state from the editor
						- I care about my development flow
						- not just typings amount
						- about composability of little dirty pieces of code 
						- easy to explore
					</textarea>
					<aside class="notes">
						- I wont be talking about why evaling arbitrary sexps is bad, there's a very similar talk but about python notepads TODO link/slide
						- I just mention, that I use emacs and I use cider, but mainly only refresh and at most 1 sexp eval of test code afterwards
						- I dont eval 2 sexps 1 after another 
						- I done eval buffers files etc
					</aside>
				</section>
				<section data-markdown>
					<textarea data-template>
						# WHY repl-first

						- copyable, immutable history
						- next command is conj
						- logged reproduce-ability
						- instead of dirty in-place reevaluation
						- TODO: ads cljsh
					</textarea>
					<aside class="notes">
						- I wont be talking about why evaling arbitrary sexps is bad, there's a very similar talk but about python notepads TODO link/slide
						- I just mention, that I use emacs and I use cider, but mainly only refresh and at most 1 sexp eval of test code afterwards
						- I dont eval 2 sexps 1 after another 
						- I done eval buffers files etc
					</aside>
				</section>
				<section data-markdown>
					<textarea data-template>
						# WHY#2

						- no clojure fork, (holy rich!)
						- nothing strange inside the committed codebase
						- not selling anything to anybody
					</textarea>
					<aside class="notes">
						- just explaining how it works for me
					</aside>
				</section>
				<section data-markdown>
					<textarea data-template>
						# why not CIDER / emacs plugin
						- use clojure / jvm batteries
						- stay in REPL
						- not access REPL state from the editor
						- 
						- explore
					</textarea>
				</section>
				<section data-markdown>
					<textarea data-template>
					  # lets talk about parens
						
					  - search for fork
					  - count difff lines for that
					</textarea>
				</section>
				<section data-markdown>
					<textarea data-template>
						# lets talk about macros
						
						- still sexps
						- validated
						- not really a language, but DSL
					</textarea>
					<aside class="notes">
						
					</aside>
				</section>
				<section data-markdown>
					<textarea data-template>
						# lets talk about read literals
						
						- beyond sexp
						- discouraged
					</textarea>
					<aside class="notes">
						
					</aside>
				</section>
				<section data-markdown>
					<textarea data-template>
						# lets talk about regexps
						
						- instead of (->> coll (filter #(re-find #"smth" %))) 
						- you want this (->> coll (filter #"smth"))
					</textarea>
					<aside class="notes">
						TODO: slide about 1 more problem
						suppose you're often working in the repl and exploring data based on filtering of text values
					</aside>
				</section>
				<section data-markdown>
					<textarea data-template>
						# lets talk about brackets
						
						- instead of `(->> coll (filter #"smth"))`
						- you want this `coll | filter #"smth"`
						- i.e. a `|` searches first fn after last `|`, if there's such arity => close bracket, go 1 level up (as may closing brackets possible), otherwise open a bracket
					</textarea>
					<aside class="notes">
						- yes you can, but I suggest to start looking at development of your own REPL instead of 
						- TODO: ads rebel-readline1
					</aside>
				</section>
				<section data-markdown>
					<textarea data-template>
						# modify prev command
						
						- `(-> obj fn-returns-coll (->> (map f1))))
						- you want this `coll | filter #"smth"`
						- i.e. a `|` searches first fn after last `|`, if there's such arity => close bracket, go 1 level up (as may closing brackets possible), otherwise open a bracket
					</textarea>
					<aside class="notes">
						- does it reminds about bash pipe? yeah, bash pipe is awesome, unfortunately it's the only the single positive featute of bash and others 
						- TODO: ads clj-condo
					</aside>
				</section>
				<section data-markdown>
					<textarea data-template>
						# lets talk about classloaders
						
						- java delegates search to parent first
						- clojure is different: top searched first
					</textarea>
					<aside class="notes">
						just to get on the same line - a couple of reminders how a typical classloader works in java
					</aside>
				</section>
				<section data-markdown>
					<textarea data-template>
						# lets talk about origins
						
						- `{}`, `[]` are clojure.lang.IMeta
						- `String`, `Integer` etc are java native
					</textarea>
					<aside class="notes">
						I wanted to track origin of the hashes in order to be able not just print 
						I just remember you, that would just help me to write (oh god no, copypaste, we all love) tests for my function
					</aside>
				</section>
				<section data-markdown>
					<textarea data-template>
						# lets talk about origins
						
						- `(def ring-req {...})
						- instead of this `(is (= {:a 1 :b {...}} (f ring-req)}))`
						- I wanted this `(is (= {:a 1 :b ring-req} (f ring-req)}))`
						- ideally I wanted to deduce the shortest possible path
						- without conditions
						- to merge constants, variables and arguments into a result
						- i.e. given a structure I wanted to ensure a presence of a unique codepath execution line corresponding to this
						- and express it in terms of assoc/dissoc/merge/conj/disj
					</textarea>
					<aside class="notes">
						I wanted to track origin of the hashes in order to be able not just print 
						I just remember you, that would just help me to write (oh god no, copypaste, we all love) tests for my function
						vars are changing but why
					</aside>
				</section>
				<section data-markdown>
					<textarea data-template>
						# let's talk about startup time
						
						- `time clj -e ''`
						- takes	2.06s on my MBP
						- clj -A / lein repl / etc on a repl project
						- takes forever
					</textarea>
				</section>
				<section data-markdown>
					<textarea data-template>
						# ideas
						
						- don't restart repl
						- TODO: ads pomergranate
						- persistent jvm
						- TODO: link to why androind slow -> core
						- reduce core by physically deleting functions
						- what if we gather eveything on runtime and assume that we don't eval 
						- again - it's DEVELOPMENT clojure build, don't use on prod
						- TODO: ads dunaj
					</textarea>
				</section>
				<section data-markdown>
					<textarea data-template>
						# fin
						
						- dream big
						- change and adapt your tools for yourself
						- think globally
						- act locally
					</textarea>
				</section>
			</div>
		</div>

		<script src="js/reveal.js"></script>

		<script>
			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
			Reveal.initialize({
				width: 2400,
				height: 1800,
				history: true,
				controls: false,
				fragments: true,
				progress: true,
				center: true,
				touch: true,
				transition: 'slide', // none/fade/slide/convex/concave/zoom
				// keyboard: {
				// 	85: uChoice, // u
				// 	68: dChoice,  // d
				// 	49: uChoice, // u, "1"
				// 	50: dChoice,  // d, "2"
				// 	82: rChoice, // r
				// 	78: nChoice, // n
				// 	80: pChoice, // p
				// 	72: goToHell  // h
				// },
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>
	</body>
</html>
